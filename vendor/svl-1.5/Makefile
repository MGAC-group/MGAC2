#
# Main makefile for SVL distribution
#

# NOTE: To build multiple system libraries in AFS, make 'afs-setup' first.
# This will create the necessary architecture-dependent lib directories,
# and ensure that the config header goes there.

REACTOR=.

all: $(REACTOR)/makefiles/config.mf
	cd src && $(MAKE) REACTOR=..

SHELL           = /bin/sh
DEST            = /usr/local
CONFIG_DEST     = $(DEST)/include

clean:	
	@-echo 'Making clean...'
	@-cd src && $(MAKE) REACTOR=.. clean
	@-rm -f lib/lib*

install: install-headers install-libs

install-headers:
	@-echo "installing into $(DEST)/include/svl $(DEST)/doc"
	@-chmod a+r include/svl/* doc/*
	@-umask 022 \
		&& mkdir -p $(DEST)/doc $(DEST)/include/svl
	@-umask 022 \
	    && cp doc/* $(DEST)/doc \
	    && cp include/svl/* $(DEST)/include/svl
	@-echo "done."

install-libs:
	@-echo "installing into $(DEST)/lib $(CONFIG_DEST)"
	@-chmod a+r lib/* include/SVLConfig.h
	@-umask 022 \
		&& mkdir -p $(DEST)/lib $(CONFIG_DEST)
	@-umask 022 \
		&& cp lib/* $(DEST)/lib \
		&& cp include/SVLConfig.h $(CONFIG_DEST)
	@-echo "done."

# setup for multi-architecture build in afs.
afs-setup:
	@-echo "Creating afs multiple-system lib directory"
	@-rm -r lib; ln -s .arch/@sys/lib lib
    # ensure the config file goes in the lib directory.
	@-ln -sf ../lib/svl/SVLConfig.h include/SVLConfig.h
    
# if lib is a broken symbolic link, create the necessary .arch directory.
afs-lib:
	@-if test ! -d lib; then mkdir -p .arch/`sys`/lib/svl; \
	   touch .arch/`sys`/lib/svl/SVLConfig.h; fi

config: afs-lib
	$(MAKE) config -f makefiles/svl.mf

# --- setup -----------

# auto-generated by make-config-mf

$(REACTOR)/makefiles/config.mf:
	@-echo "=== System Configuration ==="
	@-echo "Select one of the following systems, and then run 'make <system>'."
	@-echo 
	@-echo "	OSX"
	@-echo "	alpha"
	@-echo "	linux_RH"
	@-echo "	sgi-n32"
	@-echo "	sgi-n64"
	@-echo "	sgi-o32"
	@-echo "	solaris-gcc"
	@-echo "	sunos-gcc"
	@-echo 
	@-echo "After this is done, you can edit makefiles/config.mf to change"
	@-echo "compiler settings and paths. If you change the build flags, you"
	@-echo "must run 'make config' to update the headers."
	@exit 1

OSX:
	cp $(REACTOR)/makefiles/config-OSX.mf $(REACTOR)/makefiles/config.mf
	$(MAKE) config
alpha:
	cp $(REACTOR)/makefiles/config-alpha.mf $(REACTOR)/makefiles/config.mf
	$(MAKE) config
linux_RH:
	cp $(REACTOR)/makefiles/config-linux_RH.mf $(REACTOR)/makefiles/config.mf
	$(MAKE) config
sgi-n32:
	cp $(REACTOR)/makefiles/config-sgi-n32.mf $(REACTOR)/makefiles/config.mf
	$(MAKE) config
sgi-n64:
	cp $(REACTOR)/makefiles/config-sgi-n64.mf $(REACTOR)/makefiles/config.mf
	$(MAKE) config
sgi-o32:
	cp $(REACTOR)/makefiles/config-sgi-o32.mf $(REACTOR)/makefiles/config.mf
	$(MAKE) config
solaris-gcc:
	cp $(REACTOR)/makefiles/config-solaris-gcc.mf $(REACTOR)/makefiles/config.mf
	$(MAKE) config
sunos-gcc:
	cp $(REACTOR)/makefiles/config-sunos-gcc.mf $(REACTOR)/makefiles/config.mf
	$(MAKE) config
